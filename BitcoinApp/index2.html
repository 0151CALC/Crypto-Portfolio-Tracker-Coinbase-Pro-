<!DOCTYPE html>

<html>
    <head>
        <title>My Bitcoin Data 2</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <style>
            body {
                background-color: black;
            }
            .main {
                margin-top: 10px;
            }
            .graphsCon {
                float: left;
                height: 300px;
                width: 100%;
                position: relative;
            }
            .graphs {
                position: absolute;
                height: 300px;
                width: 100%;
            }
            .graphsOverlay {
                position: relative;
            }
            .table {
                height: 1800px;
            }
            .expandButtons {
                float: right;
                width: 50px;
                height: 50px;
                padding: 5px;
            }
            .modalGraph {
                width: 100%;
                height: 800px;
            }

            .modal-content {
                background-color: black;
            }

            @media only screen and (min-width: 992px) {
                #graphContainer {
                    padding-left: 0;
                }
            }

            @media (min-width: 200px) {
                .modal-xl {
                    width: 90%;
                    max-width: 2400px;
                }
            }
        </style>
    </head>
    <body>
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand" href="#">Bitcoin Portfolio Tracker</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Graphs<span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Table</a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <span class="navbar-text">
                        48450.37
                    </span>
                </ul>
            </div>
        </nav>
        <div class="container-fluid main">
            <div class="row">
                <div class="col-lg-7 col-sm-12">
                    <table class="table table-bordered table-dark" id="netProfitTable">
                        <thead>
                            <tr>
                                <th scope="col" onclick="sort(0, false)">Product</th>
                                <th scope="col" onclick="sort(1, false)">Date / Time</th>
                                <th scope="col">Amount</th>
                                <th scope="col" onclick="sort(3, true)">Percentage</th>
                                <th scope="col" onclick="sort(4, true)">Loss / Gain</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th scope="col" onclick="sort(0, false)">Product</th>
                                <th scope="col" onclick="sort(1, false)">Date / Time</th>
                                <th scope="col">Amount</th>
                                <th scope="col" onclick="sort(3, true)">Percentage</th>
                                <th scope="col" onclick="sort(4, true)">Loss / Gain</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="col-lg-5 col-sm-12" id="graphContainer">
                    <div class="graphsCon">
                        <div class="graphs" ID="graph1"></div>
                        <div class="graphsOverlay">
                            <button type="button" class="btn btn-dark expandButtons" data-toggle="modal" data-target="#graphModal" data-graph="graph1">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="graphsCon">
                        <div class="graphs" ID="graph2"></div>
                        <div class="graphsOverlay">
                            <button type="button" class="btn btn-dark expandButtons" data-toggle="modal" data-target="#graphModal" data-graph="graph2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="graphsCon">
                        <div class="graphs" ID="graph3"></div>
                        <div class="graphsOverlay">
                            <button type="button" class="btn btn-dark expandButtons" data-toggle="modal" data-target="#graphModal" data-graph="graph3">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="graphsCon">
                        <div class="graphs" ID="graph4"></div>
                        <div class="graphsOverlay">
                            <button type="button" class="btn btn-dark expandButtons" data-toggle="modal" data-target="#graphModal" data-graph="graph4">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="graphsCon">
                        <div class="graphs" ID="graph5"></div>
                        <div class="graphsOverlay">
                            <button type="button" class="btn btn-dark expandButtons" data-toggle="modal" data-target="#graphModal" data-graph="graph4">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="graphsCon">
                        <div class="graphs" ID="graph6"></div>
                        <div class="graphsOverlay">
                            <button type="button" class="btn btn-dark expandButtons" data-toggle="modal" data-target="#graphModal" data-graph="graph6">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="graphModal" tabindex="-1" role="dialog" aria-labelledby="graphModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="modalGraph"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script>

            $('#graphModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget)
                var graph = button.data('graph')
                var modal = $(this)
                $('#' + graph).attr("id", "");
                modal.find('.modalGraph').attr("id", graph);
            })

            $('#graphModal').on('hidden.bs.modal', function () {
                var x = document.getElementsByClassName("graphs");
                for (i = 0; i < x.length; i++) {
                    x[i].id = "graph" + (i + 1)
                }
            })

            google.charts.load('current', { 'packages': ['corechart'] });

            var graphData = {
                graph1: null,
                graph2: null,
                graph3: null,
                graph4: null,
                graph5: null,
                graph6: null,
            }

            var paused = false;

            function drawChart(graphData, graph, title, percentage) {
                var data = google.visualization.arrayToDataTable(graphData, true);

                var options = {
                    legend: 'none',
                    bar: { groupWidth: '100%' },
                    candlestick: {
                        fallingColor: { strokeWidth: 0, fill: '#a52714' },
                        risingColor: { strokeWidth: 0, fill: '#0f9d58' }
                    },
                    chartArea: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 50
                    },
                    hAxis: {
                        gridlines: {
                            color: '#FFFFFF'
                        },
                        textStyle: {
                            color: 'white'
                        }
                    },
                    vAxis: {
                        gridlines: {
                            color: '#FFFFFF'
                        },
                        textStyle: {
                            color: 'white'
                        },
                        textPosition: 'in'
                    },
                    backgroundColor: '#000000',
                    title: title,
                    titlePosition: 'in',
                    titleTextStyle: {
                        color: getNumberSignColour(Number.parseFloat(percentage))
                    }
                };

                var chart = new google.visualization.CandlestickChart(document.getElementById(graph));
                chart.draw(data, options);
            }

            var socket = io();
            var BTCPrice = 0;
            var ETHPrice = 0;
            var buyData = [];

            socket.on('graphData', function (data) {
                graphData[data.graph] = data.data
                var title = ""
                if (data.graph == "graph1") {
                    title = data.percentage + '%   | ' + getGraphDuration(data.graph) + '  |  Low: ' + data.lowest + '  |  High: ' + data.highest + '  |  Current: ' + data.data[data.data.length - 1][3]
                } else {
                    title = data.percentage + '%   | ' + getGraphDuration(data.graph) + '  |  Low: ' + data.lowest + '  |  High: ' + data.highest
                }
                google.charts.setOnLoadCallback(drawChart(graphData[data.graph], data.graph, title, data.percentage));
            })

            socket.on('data', function (data) {

                var tableData = data.buyData

                tableData.pop() //TEMP THIS IS NOT STAYING OBVIOUSLY
                tableData.pop()
                tableData.pop()

                if (document.getElementsByTagName("tbody").length == 0) {
                    var tableBody = document.createElement('tbody')
                    for (i = 0; i < tableData.length; i++) {
                        var row = document.createElement('tr');
                        row.classList.add('tableRows');
                        row.id = i
                        for (j = 0; j < tableData[i].length; j++) {
                            var cell = document.createElement('td');
                            cell.appendChild(document.createTextNode(tableData[i][j]));
                            if (tableData.length != 0 && (j == 3 || j == 4)) {
                                cell.style.color = getNumberSignColour(tableData[i][j])
                            }
                            if (j == 3) {
                                cell.innerHTML += '%'
                            }
                            row.appendChild(cell)
                        } -
                            tableBody.appendChild(row)
                    }
                    mainTable = document.getElementById('netProfitTable')
                    mainTable.appendChild(tableBody)
                    sortTable(1, false)
                } else if (document.getElementsByClassName("tableRows").length == tableData.length && !paused) {

                    var tableRows = document.getElementsByClassName("tableRows");

                    for (i = 0; i < tableRows.length; i++) {
                        row = tableRows[i].childNodes
                        for (j = 0; j < row.length; j++) {
                            row[j].innerHTML = tableData[tableRows[i].id][j]
                            if (j == 3) {
                                row[j].innerHTML += '%'
                            }
                            if ((j == 3 || j == 4)) {
                                row[j].style.color = getNumberSignColour(tableData[tableRows[i].id][j])
                            }
                        }
                    }
                }
            })

            function sortByDate(arrayOfObjects) {
                return arrayOfObjects.sort(compare)
                function compare(a, b) {

                    if (a[1] == "") {
                        return 0;
                    }

                    const dateA = a[1];
                    const dateB = b[1];

                    let comparison = 0;
                    if (dateA < dateB) {
                        comparison = -1;
                    } else if (dateA > dateB) {
                        comparison = 1;
                    }
                    return comparison;
                }
            }

            function getColour(var1, var2) {
                if (var1 < var2) {
                    return "green"
                }
                return "red"
            }

            function getNumberSignColour(number) {
                if (Math.sign(number) == 1) {
                    return "green"
                }
                return "red"
            }

            function getGraphDuration(graph) {
                switch (graph) {
                    case 'graph1':
                        return 'Last Hour'
                        break;
                    case 'graph2':
                        return 'Last 3 Hours'
                        break;
                    case 'graph3':
                        return 'Last 6 Hours'
                        break;
                    case 'graph4':
                        return 'Last Week'
                        break;
                    case 'graph5':
                        return 'Last Month'
                        break;
                    case 'graph6':
                        return 'Last 6 Months'
                        break;
                    default:
                        return 'How???'
                        break;
                }
            }

            function sort(n, parse) {
                paused = true;
                sortTable(n, parse)
                paused = false;
            }

            function sortTable(n, parse) {
                sorting = true;
                var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
                table = document.getElementById("netProfitTable");
                switching = true;
                // Set the sorting direction to ascending:
                dir = "asc";
                /* Make a loop that will continue until
                no switching has been done: */
                while (switching) {
                    // Start by saying: no switching is done:
                    switching = false;
                    rows = table.rows;

                    /* Loop through all table rows (except the
                    first, which contains table headers): */
                    for (i = 1; i < (rows.length - 1); i++) {
                        // Start by saying there should be no switching:
                        shouldSwitch = false;
                        /* Get the two elements you want to compare,
                        one from current row and one from the next: */
                        x = rows[i].getElementsByTagName("TD")[n];
                        y = rows[i + 1].getElementsByTagName("TD")[n];
                        /* Check if the two rows should switch place,
                        based on the direction, asc or desc: */

                        if (x == null || y == null) {
                            break;
                        }

                        xValue = x.innerHTML.toLowerCase()
                        yValue = y.innerHTML.toLowerCase()

                        if (parse) {
                            xValue = Number.parseFloat(x.innerHTML)
                            yValue = Number.parseFloat(y.innerHTML)
                        }

                        if (dir == "asc") {
                            if (xValue > yValue) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        } else if (dir == "desc") {
                            if (xValue < yValue) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        }
                    }
                    if (shouldSwitch) {
                        /* If a switch has been marked, make the switch
                        and mark that a switch has been done: */
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        // Each time a switch is done, increase this count by 1:
                        switchcount++;
                    } else {
                        /* If no switching has been done AND the direction is "asc",
                        set the direction to "desc" and run the while loop again. */
                        if (switchcount == 0 && dir == "asc") {
                            dir = "desc";
                            switching = true;
                        }
                    }
                }
            }
        </script>
    </body>
</html>
